using CalculatorLogic;

namespace DesktopCalculator
{
    public partial class CalculatorForm : Form
    {
        private Calculator calculator = new Calculator();

        decimal ResultValue = 0;
        string OperationPerformed = "";
        bool IsOperationPerformed = false;

        public CalculatorForm()
        {
            InitializeComponent();
        }

        private void EqualsButton_Click(object sender, EventArgs e)
        {
            try
            {
                textBox_Result.Text = calculator.PerformOperation(ResultValue, OperationPerformed, textBox_Result.Text).ToString("#.###");
                ResultValue = decimal.Parse(textBox_Result.Text);
                label_CurrentOperation.Text = "";
                textBox_Result.Focus();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error: " + ex.Message);
                textBox_Result.Text = "0";
            }

            label_CurrentOperation.Text = textBox_Result.Text + " " + button_Equals.Text;
            ResultValue = decimal.Parse(textBox_Result.Text);
            label_CurrentOperation.Text = "";

            if (OperationPerformed == "")
            {
                ResultValue = 0;
            }
            IsOperationPerformed = true;
        }

        private void InputNumber_Click(object sender, EventArgs e)
        {
            Button button = (Button)sender;

            if ((textBox_Result.Text == "0") || IsOperationPerformed)
                textBox_Result.Clear();

            IsOperationPerformed = false;

            if (button.Text == "." && !textBox_Result.Text.Contains("."))
            {
                textBox_Result.Text += button.Text;
            }
            else if (button.Text != ".")
            {
                textBox_Result.Text += button.Text;
            }

            if (ResultValue != 0)
            {
                label_CurrentOperation.Text = ResultValue + " " + OperationPerformed + textBox_Result.Text;
            }
            else
            {
                label_CurrentOperation.Text = OperationPerformed + textBox_Result.Text;
            }
        }

        private void Operation_Click(object sender, EventArgs e)
        {
            Button button = (Button)sender;

            if (ResultValue != 0)
            {
                button_Equals.PerformClick();
                OperationPerformed = button.Text;
                label_CurrentOperation.Text = ResultValue + " " + OperationPerformed;
                IsOperationPerformed = true;
            }
            else
            {
                OperationPerformed = button.Text;
                if (!string.IsNullOrEmpty(textBox_Result.Text))
                {
                    try
                    {
                        ResultValue = decimal.Parse(textBox_Result.Text);
                        IsOperationPerformed = true;
                        label_CurrentOperation.Text = ResultValue + " " + OperationPerformed;
                    }
                    catch (FormatException ex)
                    {
                        MessageBox.Show("Input string is not in the correct format.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        textBox_Result.Text = "0";
                    }
                }
            }
        }

        private void ClearEntry_Click(object sender, EventArgs e)
        {
            textBox_Result.Text = calculator.ClearEntry(textBox_Result.Text);
            IsOperationPerformed = false;
            label_CurrentOperation.Text = textBox_Result.Text;
        }

        private void Clear_Click(object sender, EventArgs e)
        {
            ResultValue = calculator.Clear(ResultValue);
            textBox_Result.Text = calculator.ClearEntry(textBox_Result.Text);
            OperationPerformed = "";
            IsOperationPerformed = false;
            label_CurrentOperation.Text = textBox_Result.Text;
        }

        private void textBox_Result_Validated(object sender, EventArgs e)
        {
            if (!textBox_Result.Text.Contains(" "))
            {
                textBox_Result.Clear();
                ResultValue = 0;
            }
        }
    }
}

namespace CalculatorLogic
{
    public class Calculator
    {
        public decimal PerformOperation(decimal resultValue, string operation, string inputValue)
        {
            decimal input;
            decimal result = 0;
            if (!decimal.TryParse(inputValue, out input))
            {
                throw new FormatException("Invalid input.");
            }

            switch (operation)
            {
                case "+":
                    result = resultValue + input;
                    break;
                case "-":
                    result = resultValue - input;
                    break;
                case "*":
                    result = resultValue * input;
                    break;
                case "/":
                    if (input != 0)
                        result = resultValue / input;
                    else
                    {
                        throw new DivideByZeroException("Cannot divide by zero.");
                    }
                    break;
                default:
                    throw new InvalidOperationException("Invalid operation.");
            }
            return Math.Round(result, 3);
        }

        public string ClearEntry(string currentValue)
        {
            return "0";
        }

        public decimal Clear(decimal resultValue)
        {
            return 0;
        }
    }
}
